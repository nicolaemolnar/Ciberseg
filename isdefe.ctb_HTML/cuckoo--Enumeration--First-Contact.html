<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>First-Contact</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>First-Contact</h1><br/>The challenge provides a file <em><strong>cuckoo_hidden.elf</strong></em>, the extension .<strong>elf</strong> means the file is an executable. The first step we are going to take is testing the exec. and try to find its vulnerabilities:<br /><div class="codebox"><pre>alex@DESKTOP-MQKMDU5<span style="color:#ff9d00;font-weight:700">:/</span>mnt<span style="color:#ff9d00;font-weight:700">/</span>c<span style="color:#ff9d00;font-weight:700">/</span>Ciberseg<span style="color:#ff9d00;font-weight:700">/</span>cuckoo$ .<span style="color:#ff9d00;font-weight:700">/</span>cuckoo_hidden.elf <br />a<br />Gracias por portarte bien <span style="color:#ff9d00;font-weight:700">:</span>)</pre></div><br /><br />As we can see, while executing the code an input prompt is displayed. After inserting any character the message <em><strong>Gracias por portarte bien :)</strong></em> is returned. The description of the challenge states that the program is completely secure against buffer overflow, so we can try overflowing the input buffer:<br /><div class="codebox"><pre>alex@DESKTOP-MQKMDU5<span style="color:#ff9d00;font-weight:700">:/</span>mnt<span style="color:#ff9d00;font-weight:700">/</span>c<span style="color:#ff9d00;font-weight:700">/</span>Ciberseg<span style="color:#ff9d00;font-weight:700">/</span>cuckoo$ .<span style="color:#ff9d00;font-weight:700">/</span>cuckoo_hidden.elf <br />aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa<br />Muy mal hecho <span style="color:#ff9d00;font-weight:700">:</span><span style="color:#3ad900;font-weight:400">&#39;(</span></pre></div><br /><br />As expected, after overflowing the buffer, the message <em><strong>Muy mal hecho :&#39;(</strong></em>  is returned. This means that the program actually is secure against buffer overflow. Let&#39;s build a python script to automatize the process of overflowing the buffer and try to scrap the size of the buffer:<br /><div class="codebox"><pre>alex@DESKTOP-MQKMDU5<span style="color:#ff9d00;font-weight:700">:/</span>mnt<span style="color:#ff9d00;font-weight:700">/</span>c<span style="color:#ff9d00;font-weight:700">/</span>Ciberseg<span style="color:#ff9d00;font-weight:700">/</span>cuckoo$ python3 overload_script.py -n 255 -f cuckoo_hidden.elf<br />Gracias por portarte bien <span style="color:#ff9d00;font-weight:700">:</span>)<br />alex@DESKTOP-MQKMDU5<span style="color:#ff9d00;font-weight:700">:/</span>mnt<span style="color:#ff9d00;font-weight:700">/</span>c<span style="color:#ff9d00;font-weight:700">/</span>Ciberseg<span style="color:#ff9d00;font-weight:700">/</span>cuckoo$ python3 overload_script.py -n 256 -f cuckoo_hidden.elf<br />Muy mal hecho <span style="color:#ff9d00;font-weight:700">:</span><span style="color:#3ad900;font-weight:400">&#39;(</span></pre></div><br />As expected, the buffer has a size of 256 bytes, meaning it can store 255 characters and the void <strong>\0</strong> character that denotes the end of a string.<br /><br />At this point there is nothing more we can think about enumerating the execution of the program. So we run the progam strings <em><strong>cuckoo_hidden.elf</strong></em> and obtain the following output:<br /><div class="codebox"><pre>alex@DESKTOP-MQKMDU5<span style="color:#ff9d00;font-weight:700">:/</span>mnt<span style="color:#ff9d00;font-weight:700">/</span>c<span style="color:#ff9d00;font-weight:700">/</span>Ciberseg<span style="color:#ff9d00;font-weight:700">/</span>cuckoo$ strings cuckoo_hidden.elf <br />4%&gt; @<br />4%  @<br />La flag es flag<span style="color:#ff9d00;font-weight:700">{</span>*************<span style="color:#ff9d00;font-weight:700">}</span><br />Gracias por portarte bien <span style="color:#ff9d00;font-weight:700">:</span>)<br />Muy mal hecho <span style="color:#ff9d00;font-weight:700">:</span><span style="color:#3ad900;font-weight:400">&#39;(<br />the.asm<br />gracias<br />print_flag<br />read_line<br />read_loop<br />not_bad<br />sigue<br />len_start<br />print<br />__bss_start<br />_edata<br />_end<br />.symtab<br />.strtab<br />.shstrtab</span><br /><span style="color:#3ad900;font-weight:400">.text<br />.data</span></pre></div><br />The output shows many interesting paths to follow:<br />	- The string <strong>La flag es flag{*************}</strong> which can be the result of the challenge, where the <strong>*</strong> characters can be overwritten with the real flag.<br />	- The strings <em>Gracias por portarte bien </em><em><span style="color:#ff9d00;">:</span></em><em>)</em> and <em>Muy mal hecho </em><em><span style="color:#ff9d00;">:</span></em><em><span style="color:#3ad900;">&#39;(</span></em> used to display messages to the user.<br />	- The strings <strong>gracias</strong>, <strong>print_flag</strong>, <strong>read_line</strong>, <strong>not_bad</strong>, <strong>sigue</strong>, etc. which have a high probability of being function names in the code.<br /><br />The next step is using gdb to debug the execution of the program:<br /><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">(gdb) print (char*) &amp;gracias</span><br />$10 = 0x402020 &quot;Gracias por portarte bien :)\n&quot;<br /><span style="color:#0088ff;font-weight:400">(gdb) p (char*) &amp;print_flag</span><br />$11 = 0x401000 &lt;print_flag&gt; &quot;H\215\064%&quot;<br /><span style="color:#0088ff;font-weight:400">(gdb) p print_flag</span><br />$13 = {&lt;text variable, no debug info&gt;} 0x401000 &lt;print_flag&gt;<br /><span style="color:#0088ff;font-weight:400">(gdb) call print_flag</span><br />$14 = {&lt;text variable, no debug info&gt;} 0x401000 &lt;print_flag&gt;<br /><span style="color:#0088ff;font-weight:400">(gdb) disassemble print_flag </span><br />Dump of assembler code for function print_flag:        <br />   0x0000000000401000 &lt;+0&gt;:     lea    0x402000,%rsi   <br />   0x0000000000401008 &lt;+8&gt;:     callq  0x4010cb &lt;print&gt;<br />   0x000000000040100d &lt;+13&gt;:    retq<br />End of assembler dump.<br /><span style="color:#0088ff;font-weight:400">(gdb) disassemble read_loop </span><br />Dump of assembler code for function read_loop:<br />   0x0000000000401031 &lt;+0&gt;:     mov    $0x0,%eax<br />   0x0000000000401036 &lt;+5&gt;:     mov    $0x0,%edi<br />   0x000000000040103b &lt;+10&gt;:    xor    %rdx,%rdx<br />   0x000000000040103e &lt;+13&gt;:    mov    -0x102(%rbp),%dx        <br />   0x0000000000401045 &lt;+20&gt;:    lea    -0x100(%rbp,%rdx,1),%rsi<br />   0x000000000040104d &lt;+28&gt;:    xor    %rdx,%rdx<br />   0x0000000000401050 &lt;+31&gt;:    mov    $0x1,%edx<br />   0x0000000000401055 &lt;+36&gt;:    syscall<br />   0x0000000000401057 &lt;+38&gt;:    mov    (%rsi),%dl<br />   0x0000000000401059 &lt;+40&gt;:    xor    %cx,%cx<br />   0x000000000040105c &lt;+43&gt;:    mov    -0x102(%rbp),%cx        <br />   0x0000000000401063 &lt;+50&gt;:    inc    %cx<br />   0x0000000000401066 &lt;+53&gt;:    mov    %cx,-0x102(%rbp)        <br />   0x000000000040106d &lt;+60&gt;:    cmp    $0xa,%dl<br />   0x0000000000401070 &lt;+63&gt;:    jne    0x401031 &lt;read_loop&gt;    <br />   0x0000000000401072 &lt;+65&gt;:    xor    %dx,%dx<br />   0x0000000000401075 &lt;+68&gt;:    mov    -0x102(%rbp),%dx        <br />   0x000000000040107c &lt;+75&gt;:    movb   $0x0,-0x103(%rbp,%rdx,1)<br />   0x0000000000401084 &lt;+83&gt;:    add    $0x102,%rsp<br />   0x000000000040108b &lt;+90&gt;:    pop    %rdx<br />   0x000000000040108c &lt;+91&gt;:    cmp    $0xcafe,%edx<br />   0x0000000000401092 &lt;+97&gt;:    je     0x4010a3 &lt;not_bad&gt;      <br />   0x0000000000401094 &lt;+99&gt;:    lea    0x40203e,%rsi<br />   0x000000000040109c &lt;+107&gt;:   callq  0x4010cb &lt;print&gt;        <br />   0x00000000004010a1 &lt;+112&gt;:   jmp    0x4010b0 &lt;sigue&gt;        <br />End of assembler dump.</pre></div><br /><br />As we can see in the code box, the execution of the program consists on an apparent loop which asks the user for input and ends when the user inserts a valid character or overflows the buffer. We are having trouble to find some of the strings and definitions discovered in the <strong>strings</strong> command, so we will use the utility <strong>elftoc</strong> from <strong>elfkickers</strong>&#39; utilities:<br /><div class="codebox"><pre>alex@DESKTOP-MQKMDU5<span style="color:#ff9d00;font-weight:700">:/</span>mnt<span style="color:#ff9d00;font-weight:700">/</span>c<span style="color:#ff9d00;font-weight:700">/</span>Ciberseg<span style="color:#ff9d00;font-weight:700">/</span>cuckoo$ ..<span style="color:#ff9d00;font-weight:700">/</span>Utilities<span style="color:#ff9d00;font-weight:700">/</span>elfkickers<span style="color:#ff9d00;font-weight:700">/</span>elftoc cuckoo_hidden.elf &gt; cuckoo_hidden.c</pre></div><br />This command will create the file <strong>cuckoo_hidden.c</strong> which will contain a representation of the memory map of the execution with C structures. This code gives us a more intuitive way of reading the data of the elf, e. g.:<br /><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">/* data */</span><br />  <span style="color:#3ad900;font-weight:400">&quot;La flag es flag{*************}\n\0Gracias por portarte bien :)\n\0Muy mal&quot;</span><br />    <span style="color:#3ad900;font-weight:400">&quot; hecho :&#39;(\n&quot;</span>,</pre></div><br />Where we can find all the explicit strings stored in the elf file. Also, we can obtain the symbol table and its structura like:<br /><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">/* flag */</span><br />    { <span style="color:#ff0044;font-weight:400">27</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_DATA,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, data), <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* gracias */</span><br />    { <span style="color:#ff0044;font-weight:400">9</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_DATA,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, data) + <span style="color:#ff0044;font-weight:400">0x20</span>, <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* mal */</span><br />    { <span style="color:#ff0044;font-weight:400">17</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_DATA,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, data) + <span style="color:#ff0044;font-weight:400">0x3E</span>, <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* print_flag */</span><br />    { <span style="color:#ff0044;font-weight:400">21</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_TEXT,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, text), <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* read_line */</span><br />    { <span style="color:#ff0044;font-weight:400">32</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_TEXT,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, text) + <span style="color:#ff0044;font-weight:400">0x18</span>, <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* read_loop */</span><br />    { <span style="color:#ff0044;font-weight:400">42</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_TEXT,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, text) + <span style="color:#ff0044;font-weight:400">0x31</span>, <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* not_bad */</span><br />    { <span style="color:#ff0044;font-weight:400">52</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_TEXT,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, text) + <span style="color:#ff0044;font-weight:400">0xA3</span>, <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* sigue */</span><br />    { <span style="color:#ff0044;font-weight:400">60</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_TEXT,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, text) + <span style="color:#ff0044;font-weight:400">0xB0</span>, <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* len */</span><br />    { <span style="color:#ff0044;font-weight:400">66</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_TEXT,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, text) + <span style="color:#ff0044;font-weight:400">0xB2</span>, <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* len_start */</span><br />    { <span style="color:#ff0044;font-weight:400">70</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_TEXT,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, text) + <span style="color:#ff0044;font-weight:400">0xB9</span>, <span style="color:#ff0044;font-weight:400">0</span> },<br />    <span style="color:#0088ff;font-weight:400">/* print */</span><br />    { <span style="color:#ff0044;font-weight:400">80</span>, ELF64_ST_INFO(STB_LOCAL, STT_NOTYPE), STV_DEFAULT, SHN_TEXT,<br />      ADDR_TEXT + <span style="color:#ff9d00;font-weight:400">offsetof</span>(elf, text) + <span style="color:#ff0044;font-weight:400">0xCB</span>, <span style="color:#ff0044;font-weight:400">0</span> },</pre></div><br />Where <strong>SHN_DATA</strong> represents explicit strings and SHN_TEXT represents the names of the methods used in the program..</div>
</body>
</html>
